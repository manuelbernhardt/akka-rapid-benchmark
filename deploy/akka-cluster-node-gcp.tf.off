provider "google" {
  credentials = file("~/Akka-Rapid.json"),
  project = "akka-rapid",
  region = var.region,
  zone = var.availability_zone
}

resource "google_compute_attached_disk" "template-disk" {
    disk     = google_compute_disk.template-disk.self_link
    instance = google_compute_instance.akka-template-instance.self_link
}

resource "google_compute_instance" "akka-template-instance" {
    name         = "akka-template-instance"
    machine_type = "n1-standard-1"
    zone         = "us-west1-a"

    tags         = [ "${var.tag_name}-template" ]

    metadata     = {
        seed = "TEMPLATE",
        ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"
    }

    boot_disk {
        initialize_params {
            image = "gce-uefi-images/ubuntu-1804-lts"
        }
    }

    network_interface {
        network = "default"

        access_config {
            // ephemeral ip
        }

    }

    lifecycle {
        ignore_changes = [attached_disk]
    }

    connection {
        type        = ssh
        host        = self.network_interface.0.access_config.0.nat_ip
        user        = lookup(var.user, var.platform)
        private_key = file("~/.ssh/id_rsa")
    }

    provisioner "file" {
        source      = "${path.module}/profile.sh"
        destination = "/home/ubuntu/profile.sh"
    }
    provisioner "file" {
        source      = "${path.module}/akka-cluster"
        destination = "/home/ubuntu/akka-cluster"
    }
    provisioner "file" {
        source      = "${path.module}/akka-cluster-seed"
        destination = "/home/ubuntu/akka-cluster-seed"
    }
    provisioner "file" {
        content     = templatefile("${path.module}/filebeat.yml.tpl", {
            cloud_id = var.elastic_cloudid,
            cloud_auth = var.elastic_cloudauth,
            kibana_host = var.elastic_kibana
        })
        destination = "/tmp/filebeat.yml"
    }
    provisioner "file" {
        source      = "${path.module}/../target/universal/akka-rapid-benchmark-1.0.zip"
        destination = "/tmp/akka-rapid-benchmark-1.0.zip"
    }

    provisioner "remote-exec" {
        inline = [
            "echo ${var.elastic_cloudid} > /tmp/elastic-cloudid",
            "echo ${var.elastic_cloudauth} > /tmp/elastic-cloudauth",
            "echo ${var.elastic_kibana} > /tmp/elastic-kibana",
            "echo ${var.system_name} > /tmp/system-name",
            "echo ${aws_iam_access_key.akka.id} > /tmp/aws-access-key-id",
            "echo ${aws_iam_access_key.akka.secret} > /tmp/aws-access-key-secret",
            "echo ${var.region} > /tmp/aws-region",
            "chmod +x /home/ubuntu/profile.sh"
        ]
    }

    provisioner "remote-exec" {
        scripts = [
            "${path.module}/install.sh",
            "${path.module}/ip_tables.sh",
        ]
    }
}

resource "google_compute_image" "akka-rapid" {
    name = "akka-rapid"
    source_disk = google_compute_attached_disk.template-disk.id
}

resource "google_compute_instance" "akka_seed_node" {
    name = "akka-seed"

    boot_disk {
        initialize_params {
            image = google_compute_image.akka-rapid.id
        }
    }

    machine_type = "n1-highcpu-16"

    zone = var.availability_zone

    tags         = [ "${var.tag_name}-seed" ]

    metadata     = {
        seed = "SEED",
        members = var.members,
        ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"
    }

    connection {
        type        = ssh
        host        = self.network_interface.0.access_config.0.nat_ip
        user        = lookup(var.user, var.platform)
        private_key = file("~/.ssh/id_rsa")
    }

    provisioner "file" {
        source      = "${path.module}/install-monit-seed.sh"
        destination = "/tmp/install-monit-seed.sh"
    }

    provisioner "remote-exec" {
        inline = [
            "chmod +x /tmp/install-monit-seed.sh",
            "/tmp/install-monit-seed.sh 'SEED'"
        ]
    }

    network_interface {
        network = "default"

        access_config {
            // ephemeral ip
        }

    }

}

resource "google_compute_instance" "akka_node" {
    count = var.servers - 1
    name  = "akka-${count}"

    boot_disk {
        initialize_params {
            image = google_compute_image.akka-rapid.id
        }
    }

    machine_type = "n1-highcpu-2"

    zone = var.availability_zone

    tags         = [ var.tag_name ]

    metadata     = {
        seed = google_compute_instance.akka_seed_node.id,
        members = var.members,
        ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"
    }

    connection {
        type        = ssh
        host        = self.network_interface.0.access_config.0.nat_ip
        user        = lookup(var.user, var.platform)
        private_key = file("~/.ssh/id_rsa")
    }

    network_interface {
        network = "default"

        access_config {
            // ephemeral ip
        }

    }

}